upstream php-api {
	server v_wbc_api_fpm:9000;
}

log_format upstream_time '$remote_addr - $remote_user [$time_local] '
                             '"$request" $status $body_bytes_sent '
                             '"$http_referer" "$http_user_agent"'
                             'rt=$request_time uct="$upstream_connect_time" uht="$upstream_header_time" urt="$upstream_response_time"';

server {
	  listen 80;
	  server_name api-wbc.fomazov.name;
	  return 301 https://$server_name$request_uri;  # enforce https
}

server {
    include config/snippet/ssl.conf;

	  server_name api-wbc.fomazov.name;
	  root /var/www/api-html/public;

	  ssl_certificate      config/ssl/fomazov.name/wildcard.crt;
	  ssl_certificate_key  config/ssl/fomazov.name/wildcard.pem;

    gzip  on;
    index index.php;

    error_log  /dev/fd/2;
    access_log  /dev/fd/2  upstream_time;

    location / {
        try_files $uri $uri/ /index.php?_url=$uri&$args;
    }

	set $pass 'php-api';
	include config/snippet/php.conf;
	include config/snippet/drop.conf;
  include config/snippet/source-cache.conf;
}
